<analysis>**original_problem_statement**: The user initiated a series of requests to fix critical bugs and add new features to a client and booking management application.

**PRODUCT REQUIREMENTS**:
1.  **Bug Fix (P0):** Approved clients are not visible in the booking dropdown for employees, blocking them from creating bookings.
2.  **Bug Fix:** In the Booking Confirmation Request email, the label Landing price should be changed to Selling Price, and the displayed value should be the actual selling price.
3.  **Bug Fix:** The accept/deny booking links in confirmation emails point to a test/preview server URL instead of the production deployment server.
4.  **Feature:** When a client mapping is changed, the newly mapped user should see all previous bookings for that client, regardless of who created them.
5.  **Bug Fix:** After a payment is completed and the booking becomes DP ready, the payment status incorrectly shows pending instead of paid.
6.  **Bug Fix (P0):** When approving a client, the system shows missing mandatory documents even if OCR was performed. PE-level users cannot access or download these documents.
7.  **Feature:** Provide a way to configure the  for production environments, possibly through a UI setting similar to what exists in Company Master.
8.  **Feature:** Enforce a strict rule to prevent client creation if mandatory documents have not been successfully uploaded and stored in GridFS. The process should be: run OCR, upload and store files in GridFS, then create the client record.
9.  **Feature:** Add a Reveal Document button on the Client page to perform a deep search in GridFS for a client's documents and link them if found, as a safeguard for cases where documents might exist but are unlinked.
10. **Improvement:** Enhance the OCR process (Deep run OCR) as it is making many mistakes. Specifically, for the Cancelled Cheque document type, also support Bank Statements or Passbook copies and extract bank details from them.
11. **Bug Fix:** The Wati WhatsApp integration is not working.

**User's preferred language**: English

**what currently exists?**
The application is a client and booking management system built with a React frontend and a FastAPI (Python) backend using MongoDB with GridFS for document storage. It supports different user roles, such as Partners Desk (PE) and Employee, with distinct permissions. Key features include client creation with OCR-based data extraction, booking management, and notification workflows via email.

**Last working item**:
-   **Last item agent was working**: The agent was investigating why the Wati WhatsApp integration is not functional. The agent successfully identified the root cause: the integration is disabled and its configuration (API endpoint and token) is missing from the Company Master settings in the database.
-   **Status**: IN PROGRESS
-   **Agent Testing Done**: N
-   **Which testing method agent to use?**: Manual testing by user. The user needs to provide the correct Wati credentials and enable the integration in the UI. The agent can then guide the user to test if a WhatsApp message is triggered upon a relevant event (e.g., booking creation).
-   **User Testing Done**: N

**All Pending/In progress Issue list**:
-   **Issue 1**: Wati WhatsApp integration is not working. (Priority: P0)

**Issues Detail**:
-   **Issue 1: Wati WhatsApp integration is not working.**
    -   **Attempted fixes**: The agent investigated the backend code (, ) and checked the database configuration for . It was confirmed that the feature is disabled () and the required credentials (, ) are empty.
    -   **Next debug checklist**:
        1.  Guide the user to the Company Master settings page in the UI.
        2.  Instruct the user on where to find their Wati API Endpoint and Access Token.
        3.  Have the user input these credentials into the UI and enable the integration.
        4.  Trigger an event that sends a WhatsApp message to verify the fix.
    -   **Why fix this issue and what will be achieved with the fix?**: Fixing this will enable automated WhatsApp notifications for key business events, improving communication with clients.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: N
    -   **Should Test frontend/backend/both after fix?**: Both (UI for saving settings, Backend for sending messages).
    -   **Blocked on other issue**: Blocked on the user providing their Wati API credentials.

**In progress Task List**:
-   There are no other in-progress tasks.

**Upcoming and Future Tasks**
-   There are no outstanding future tasks mentioned by the user.

**Completed work in this session**
-   **Client Booking Dropdown Fix**: Resolved an issue where employees couldn't see mapped clients. The root cause was a failing  in the frontend which prevented the client list from being populated. (File: ).
-   **Booking Visibility Logic**: Updated the backend so employees can view all bookings associated with a client mapped to them, not just the bookings they created. (File: ).
-   **Payment Status Fix**: Corrected the logic to ensure the  is updated to paid when a payment makes a booking DP ready. (File: ).
-   **Document Access & Download Fix**: Fixed a field name mismatch ( vs ) that prevented document downloads. (File: ).
-   **Feature - Upload Docs for Existing Clients**: Enabled the Documents tab in the client edit dialog, allowing PE users to upload missing documents for existing clients. (File: ).
-   **Strict Client Creation**: Re-architected the client creation flow to be atomic. Documents are now uploaded and verified in GridFS *before* the client record is created, preventing clients from existing without documents. A new endpoint  was created for this. (Files: , ).
-   **Feature - Reveal Document Button**: Added a button on the Clients page to search GridFS for any unlinked documents for a client and associate them. (Files: , ).
-   **Email Template & URL Fixes**:
    -   Updated email templates in the database and code to use Sale Price instead of Landing Price. (File: ,  and direct DB update).
    -   Implemented a UI in Company Master for setting a , which is now used to generate correct production URLs in email links. (Files: , , ).
-   **OCR Improvements**:
    -   Enhanced OCR prompts for better accuracy.
    -   Added support for Bank Statements and Passbooks as alternatives to Cancelled Cheques, updating both the OCR service and the frontend UI. (Files: , ).

**Earlier issues found/mentioned but not fixed**
-   None. All raised issues have been addressed.

**Known issue recurrence from previous fork**
-   None.

**Code Architecture**


**Key Technical Concepts**
-   **Backend**: FastAPI (Python), Pydantic models, Motor (async MongoDB driver).
-   **Frontend**: React.js, JavaScript, Shadcn UI components, Axios for API calls.
-   **Database**: MongoDB.
-   **File Storage**: GridFS for storing client documents.
-   **OCR**: An external LLM-based service is used for Optical Character Recognition on client documents.

**key DB schema**
-   **clients**: 
-   **bookings**: 
-   **company_master**: 
-   **email_templates**: 
-   **fs.files (GridFS)**: 

**changes in tech stack**
-   No changes were made to the core technology stack.

**All files of reference**
-   : Major changes to implement atomic client creation, document download fix, and the reveal documents feature.
-   : Heavily modified to support the new atomic client creation flow, allow document uploads for existing clients, add the reveal button, and update OCR document type labels.
-   : Updated to fix booking visibility for mapped employees and correct payment status logic.
-   : Fixed a critical bug where a failing promise prevented the client dropdown from loading.
-   : Updated with improved prompts and logic to handle bank statements/passbooks.
-   : Updated email content to change Landing Price to Sale Price.
-    & : Modified to add and manage the  setting for production email links.
-   : Investigated for the Wati integration issue.

**Areas that need refactoring**:
-   There are two  classes defined, one in  and another within . These should be consolidated into a single service for consistency and maintainability.

**key api endpoints**
-   : **(New)** Atomically creates a client after uploading and verifying documents in GridFS. This is now the primary method for client creation.
-   : **(Modified)** This endpoint is now blocked from creating new clients to enforce the strict document upload policy.
-   : **(New)** Searches GridFS for documents belonging to a client and links them.
-   : **(Modified)** Query logic was updated to show bookings for mapped clients.
-   : **(Modified)** Updated to save the  field.

**Critical Info for New Agent**
-   **Atomic Client Creation**: The most critical change is that clients **must** be created via the  endpoint. This flow ensures documents are stored in GridFS *before* the client record is created. The old  endpoint will now reject attempts to create new clients.
-   **Configurable Frontend URL**: The URL used in email confirmation links is no longer hardcoded or reliant solely on an environment variable. It is now primarily sourced from the  field set in the Company Master UI. The system falls back to environment variables if the  is not set.

**documents and test reports created in this job**
-   : This document was updated multiple times to reflect the status of completed tasks.

**Last 10 User Messages and any pending HUMAN messages**
1.  **User (Message 669):** the wati whatsapp integration is not working - **IN PROGRESS**
2.  **User (Message 636):** Requested to change Landing price to Sale Price in the booking confirmation email. - **DONE**
3.  **User (Message 579):** Requested to improve OCR accuracy and add support for bank statements/passbooks as alternatives to cancelled cheques. - **DONE**
4.  **User (Message 550):** Re-iterated the requirement for strict client creation: documents must be in GridFS before the client record is created. - **DONE**
5.  **User (Message 515):** Corrected the agent, stating the Reveal Document button should be on the Client page, not the Booking page. - **DONE**
6.  **User (Message 458):** Requested a Reveal Document button on the Booking page to find client documents in GridFS. - **DONE (and moved)**
7.  **User (Message 405):** Requested to prevent client creation if documents are not uploaded and stored in GridFS first. - **DONE**
8.  **User (Message 318):** Reported a persistent and frustrating issue where PE users cannot see or access documents for clients, causing approval failures. - **DONE**
9.  **User (Message 265):** Requested a UI setting (Option 2) to configure the  for production emails. - **DONE**
10. **User (Message 263):** Asked for clarification on how to update the  for production. - **DONE**

**Project Health Check:**
-   **Broken**: The Wati WhatsApp integration is currently non-functional due to missing configuration.
-   **Mocked**: No components are mocked.

**3rd Party Integrations**
-   **Emergent LLM**: Used for the OCR service to extract data from uploaded documents. Uses the Emergent LLM Key.
-   **Wati (WhatsApp)**: Used for sending WhatsApp notifications. Requires a User-provided API Key (Endpoint and Token).

**Testing status**
-   **Testing agent used after significant changes**: YES. The testing agent was used to validate fixes for the client dropdown, booking visibility, payment status, and document download issues.
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**: None.
-   **Known regressions**: None identified.

**Credentials to test flow:**
-   **PE Desk User**:  / 
-   **Employee User**:  / 
-   **Fresh Employee User**:  / </analysis>
